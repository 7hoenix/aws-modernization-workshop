---
AWSTemplateFormatVersion: 2010-09-09
Description: AWS Modernization Workshop - Continuous Integration (CI) (20180814).
  This CloudFormation template creates an AWS CodeCommit and AWS Cloud9 development
  environment, launches an Amazon EC2 instance running Amazon Linux, connects the
  new instance to the new environment, and clones the CodeCommit repository into the
  environment.
Metadata:
  LICENSE: |-
    Copyright 2017 Amazon Web Services
    Licensed under the Apache License, Version 2.0 (the "License"); you may not use this file except in compliance with the License. You may obtain a copy of the License at

      http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software distributed under the License is distributed on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for the specific language governing permissions and limitations under the License.
  AWS::CloudFormation::Interface:
    ParameterGroups:
    - Label:
        default: AWS CodeCommit Configuration
      Parameters:
      - CCRepo
    - Label:
        default: AWS Cloud9 Configuration
      Parameters:
      - Cloud9EnvName
      - InstanceType
      - VPCID
      - SubnetID
    ParameterLabels:
      CCRepo:
        default: Repository Name
      InstanceType:
        default: EC2 Instance Type
      Cloud9EnvName:
        default: Environment Name
      SubnetID:
        default: Subnet ID
      VPCID:
        default: VPC ID
Parameters:
  CCRepo:
    Description: Desired name for your repository.
    Type: String
    Default: aws_pet_store_repo
  Cloud9EnvName:
    Description: Name of your Cloud9 environment.
    Type: String
    Default: pet-store-lab
  InstanceType:
    Description: The type of instance to host the environment.
    Type: String
    Default: t2.micro
    AllowedValues:
    - t2.micro
    - t2.small
    - m4.large
    - t2.nano
    - c4.large
    - t2.medium
    - t2.large
    - m4.xlarge
    - t2.xlarge
    - c4.xlarge
    - c4.2xlarge
    - m4.2xlarge
    - t2.2xlarge
    - c4.4xlarge
    - m4.4xlarge
    - c4.8xlarge
    - m4.10xlarge
    - m4.16xlarge
  SubnetID:
    Type: AWS::EC2::Subnet::Id
    Description: ID of subnet in Availability Zone, e.g., subnet-a0246dcd
  VPCID:
    Description: ID of your existing VPC for deployment
    Type: AWS::EC2::VPC::Id
Rules:
  SubnetsInVPC:
    Assertions:
    - Assert:
        Fn::EachMemberIn:
        - Fn::ValueOfAll:
          - AWS::EC2::Subnet::Id
          - VpcId
        - Fn::RefAll: AWS::EC2::VPC::Id
      AssertDescription: All subnets must be in the VPC
Resources:
  CCRepository:
    Type: AWS::CodeCommit::Repository
    Properties:
      RepositoryName:
        Ref: CCRepo
  CloudNine:
    Type: AWS::Cloud9::EnvironmentEC2
    DependsOn: CCRepository
    Properties:
      Name:
        Ref: Cloud9EnvName
      InstanceType:
        Ref: InstanceType
      SubnetId:
        Ref: SubnetID
      Repositories:
      - PathComponent:
          Fn::GetAtt: CCRepository.Name
        RepositoryUrl:
          Fn::GetAtt: CCRepository.CloneUrlHttp
Outputs:
  CCRepo:
    Description: Clone URL for AWS CodeCommit Pet Store Repository
    Value:
      Fn::GetAtt: CCRepository.CloneUrlHttp
...
